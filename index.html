<!DOCTYPE html>
<html style="margin: 0; padding: 0;">
    <head>
        <title>Game</title>
        <script src="jquery-3.1.1.min.js"></script>
        <script src="howler.min.js"></script>
    </head>
    <body style="margin: 0; padding: 0; background: black;">
        <canvas width="800" height="600" allowfullscreen="true" id="gameCanvas" style="margin-left: 10px; margin-top: 10px;"></canvas>
        <script>

function hwl(name, volume) {
    return new Howl({src: ["sounds/" + name + ".ogg", "sounds/" + name + ".mp3", "sounds/" + name + ".wav"], volume: volume || 1});
}

var NORTH = 1;
var SOUTH = 2;
var EAST = 3;
var WEST = 4;

var dirs = [
    {
        key: "W",
        arrow: 38,
        dx: 0,
        dy: -1,
        angle: -Math.PI / 2
    },
    {
        key: "S",
        arrow: 40,
        dx: 0,
        dy: 1,
        angle: Math.PI / 2
    },
    {
        key: "A",
        arrow: 37,
        dx: -1,
        dy: 0,
        angle: Math.PI
    },
    {
        key: "D",
        arrow: 39,
        dx: 1,
        dy: 0,
        angle: 0
    }
];

function tick(ms) {
    c.resetTransform();
    c.fillStyle = "black";
    c.fillRect(0, 0, canvas.width, canvas.height);
    img("test", 0, 0);
    if (masks["test"]) {
        var m = masks["test"];
        c.fillStyle = "red";
        for (var y = 0; y < m.length; y++) { for (var x = 0; x < m[0].length; x++) {
            if (m[y][x]) {
                c.fillRect(x, y, 1, 1);
            }
        }}
    }

    p.physics(ms/1000.0);
    p.draw();
}

var p = new Player();

function Player(){
    var posX = 0;
    var posY = 0;
    var speed = 1;

    this.physics = function(delta){
        dirs.forEach(function(element) {
            if(keys[element.key] || keyCodes[element.arrow]){
                posX += element.dx * speed * delta;
                posY += element.dy * speed * delta;
                console.log(element.key);
            }
            
        }, this);
    }

    this.draw = function(){
        img("spritesheet", posX, posY);
    }
}

var images = {};

function img(img, x, y) {
    if (img == null) { return; }
    if (!images[img]) {
        images[img] = new Image();
        images[img].src = "graphics/" + img + ".png";
    }
    c.drawImage(images[img], x, y);
}

var masks = {};

function cacheMask(img) {
    var tmpImg = new Image();
    tmpImg.onload = function() {
        var tmpCanvas = document.createElement("canvas");
        tmpCanvas.width = tmpImg.width;
        tmpCanvas.height = tmpImg.height;
        var tmpCtx = tmpCanvas.getContext("2d");
        tmpCtx.drawImage(tmpImg, 0, 0);
        var tmpData = tmpCtx.getImageData(0, 0, tmpImg.width, tmpImg.height).data;
        var mask = [];
        for (var y = 0; y < tmpImg.height; y++) {
            var row = [];
            mask.push(row);
            for (var x = 0; x < tmpImg.width; x++) {
                var value = tmpData[(y * tmpImg.width * 4) + x * 4];
                row.push(value != 0);
            }
        }
        masks[img] = mask;
    };
    tmpImg.src = "graphics/" + img + ".png";
}

cacheMask("test");

var canvas = document.getElementById("gameCanvas");
var c = canvas.getContext("2d");
var keys = {};
var keyCodes = {};
var click = null;
var mouseDown = false;
var cursor = {x: 300, y: 300};

// Listen for key presses.
function canvasKeyUp(e) {
    keyCodes[e.which] = true;
    keys[String.fromCharCode(e.which)] = true;
}

function pressed(key) {
    return !!keys[key] || !!keyCodes[key];
}

$('body').keypress(canvasKeyUp);

// Listen for mouse stuff.
function canvasClick(e) {
    click = { "x": e.offsetX, "y": e.offsetY };
}

function canvasMouseDown(e) {
    mouseDown = true;
}

function canvasMouseUp(e) {
    mouseDown = false;
}

function canvasMove(e) {
    cursor = { "x": e.offsetX, "y": e.offsetY };
}

$('#gameCanvas').click(canvasClick).mousemove(canvasMove).mousedown(canvasMouseDown).mouseup(canvasMouseUp);

// Set up game loop.
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
var lastUpdate = new Date().getTime();

function nextFrame() {
    var currentTime = new Date().getTime();
    tick(currentTime - lastUpdate);
    keys = {};
    keyCodes = {};
    click = null;
    lastUpdate = currentTime;
    requestAnimationFrame(nextFrame);
}

// Once everything is set up, start game loop.
requestAnimationFrame(nextFrame);

jQuery(window).resize(function() {
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight - 20;
});
jQuery(window).ready(function() {
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight - 20;
});
 
/*canvas.addEventListener("click", function() {
    if (canvas.webkitRequestFullScreen) {
        canvas.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
    } else if (canvas.mozRequestFullScreen) {
        canvas.mozRequestFullScreen();
    } else if (canvas.requestFullScreen) {
        canvas.requestFullScreen();
    }
});*/
        </script>
    </body>
</html>
